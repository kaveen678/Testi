<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cricheart - Live TV Platform</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.6.0/shaka-player.compiled.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #0c0c0c;
            --card-color: #181818;
            --accent: #ff003c;
            --text: #ffffff;
            --secondary-text: #aaaaaa;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding-bottom: 50px;
        }

        header {
            background: #000;
            padding: 15px 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid #222;
        }

        .logo {
            font-size: 22px;
            font-weight: 800;
            letter-spacing: 1px;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo i { color: var(--accent); font-size: 28px; }
        .logo span { color: var(--accent); }

        .main-player {
            width: 100%;
            max-width: 1000px;
            margin: 20px auto;
            background: #000;
            aspect-ratio: 16/9;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        video { width: 100%; height: 100%; outline: none; }

        .container { max-width: 1200px; margin: 0 auto; padding: 0 15px; }

        .search-container { margin: 20px 0; position: relative; }
        .search-bar {
            width: 100%;
            padding: 14px 20px;
            background: var(--card-color);
            border: 1px solid #333;
            border-radius: 30px;
            color: white;
            font-size: 16px;
            box-sizing: border-box;
            outline: none;
        }

        .categories {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 15px;
            scrollbar-width: none;
        }

        .cat-btn {
            background: #252525;
            border: none;
            color: white;
            padding: 8px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: 0.2s;
            white-space: nowrap;
        }

        .cat-btn.active, .cat-btn:hover { background: var(--accent); }

        .channel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .channel-card {
            background: var(--card-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s, border 0.2s;
            border: 1.5px solid transparent;
        }

        .channel-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent);
        }

        .channel-card img {
            height: 60px;
            max-width: 100%;
            object-fit: contain;
            margin-bottom: 12px;
        }

        .channel-card .name {
            display: block;
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        footer {
            margin-top: 60px;
            padding: 40px 20px;
            text-align: center;
            background: #050505;
            border-top: 1px solid #1a1a1a;
        }

        .footer-content h3 { color: var(--accent); }
    </style>
</head>
<body>

<header>
    <div class="logo"><i class="fas fa-play-circle"></i> CRIC<span>HEART</span></div>
    <div id="clock" style="font-size: 14px; color: var(--secondary-text);"></div>
</header>

<div class="main-player">
    <video id="video" controls autoplay poster="https://via.placeholder.com/1000x560/000/fff?text=Loading+Channels..."></video>
</div>

<div class="container">
    <div class="search-container">
        <input type="text" id="search" class="search-bar" placeholder="Search 1100+ Channels...">
    </div>

    <div class="categories" id="cat-list">
        <button class="cat-btn active" onclick="filterCategory('All')">All</button>
    </div>

    <h3 id="count-text" style="margin-top:25px; font-weight: 400; color: var(--secondary-text);">Playlist: Connecting...</h3>
    <div class="channel-grid" id="channel-grid"></div>
</div>

<footer>
    <div class="footer-content">
        <h3>CRICHEART LIVE</h3>
        <p>Â© 2026 Cricheart TV. Premium Web Experience.</p>
    </div>
</footer>

<script>
    const m3uUrl = 'https://raw.githubusercontent.com/pk3011/pkjtv/refs/heads/main/jtv.m3u';
    let allChannels = [];
    let player = null;

    async function initPlayer() {
        shaka.polyfill.installAll();
        const video = document.getElementById('video');
        player = new shaka.Player(video);
    }

    async function playChannel(ch) {
        if (!player) await initPlayer();
        player.getNetworkingEngine().clearAllRequestFilters();
        
        player.getNetworkingEngine().registerRequestFilter((type, request) => {
            if (ch.userAgent) request.headers['User-Agent'] = ch.userAgent;
            if (ch.cookie && ch.cookie.cookie) {
                const sep = request.uris[0].includes('?') ? '&' : '?';
                request.uris[0] += sep + ch.cookie.cookie;
            }
        });

        if (ch.clearKeyId && ch.clearKeyKey) {
            player.configure({ drm: { clearKeys: { [ch.clearKeyId]: ch.clearKeyKey } } });
        } else {
            player.configure({ drm: { clearKeys: {} } });
        }

        try {
            await player.load(ch.manifestUri);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        } catch (e) { alert("Error playing channel."); }
    }

    // Function with robust Proxy logic
    async function fetchPlaylist() {
        const statusTxt = document.getElementById('count-text');
        // Primary Proxy: AllOrigins, Secondary: Corsproxy.io
        const proxies = [
            'https://api.allorigins.win/raw?url=',
            'https://corsproxy.io/?'
        ];

        let data = null;

        for (let proxy of proxies) {
            try {
                const response = await fetch(proxy + encodeURIComponent(m3uUrl));
                if (response.ok) {
                    data = await response.text();
                    break; 
                }
            } catch (err) { console.warn("Proxy failed, trying next..."); }
        }

        if (data) {
            parseM3U(data);
        } else {
            statusTxt.innerText = "Error: Use a VPN or refresh the page.";
        }
    }

    function parseM3U(data) {
        const lines = data.split('\n');
        let current = null;
        allChannels = [];

        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (line.startsWith('#EXTINF:')) {
                current = {
                    name: line.split(',')[1] || "Unknown",
                    logo: line.match(/tvg-logo="([^"]+)"/)?.[1] || "",
                    group: line.match(/group-title="([^"]+)"/)?.[1] || "General",
                    manifestUri: "",
                    clearKeyId: null, clearKeyKey: null, userAgent: null, cookie: null
                };
            } else if (line.startsWith('#KODIPROP:inputstream.adaptive.license_key=')) {
                const parts = line.split('=')[1].split(':');
                if (parts.length === 2) { current.clearKeyId = parts[0]; current.clearKeyKey = parts[1]; }
            } else if (line.startsWith('#EXTVLCOPT:http-user-agent=')) {
                current.userAgent = line.split('=')[1];
            } else if (line.startsWith('#EXTHTTP:')) {
                try { current.cookie = JSON.parse(line.substring(9)); } catch(e){}
            } else if (line && !line.startsWith('#')) {
                if (current) {
                    current.manifestUri = line;
                    allChannels.push(current);
                    current = null;
                }
            }
        }
        renderChannels(allChannels);
        updateCategories();
        document.getElementById('count-text').innerText = `Channels (${allChannels.length})`;
    }

    function renderChannels(list) {
        const grid = document.getElementById('channel-grid');
        grid.innerHTML = list.map(ch => `
            <div class="channel-card" onclick='playChannel(${JSON.stringify(ch).replace(/'/g, "&apos;")})'>
                <img src="${ch.logo}" onerror="this.src='https://via.placeholder.com/150?text=TV'">
                <span class="name">${ch.name}</span>
            </div>
        `).join('');
    }

    function updateCategories() {
        const cats = ['All', ...new Set(allChannels.map(ch => ch.group))].slice(0, 15);
        const catList = document.getElementById('cat-list');
        catList.innerHTML = cats.map(c => `<button class="cat-btn ${c==='All'?'active':''}" onclick="filterCategory('${c}')">${c}</button>`).join('');
    }

    function filterCategory(cat) {
        document.querySelectorAll('.cat-btn').forEach(btn => btn.classList.toggle('active', btn.innerText === cat));
        const filtered = (cat === 'All') ? allChannels : allChannels.filter(ch => ch.group === cat);
        renderChannels(filtered);
    }

    document.getElementById('search').addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        renderChannels(allChannels.filter(ch => ch.name.toLowerCase().includes(term)));
    });

    setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString(); }, 1000);
    window.onload = () => { initPlayer(); fetchPlaylist(); };
</script>
</body>
</html>
